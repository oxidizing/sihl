<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>index (sihl-token.index)</title><link rel="stylesheet" href="../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ sihl-token</nav><h1 id="sihl-token"><a href="#sihl-token" class="anchor"></a>Sihl Token</h1><p>A token is a string that has some values associated with it. Tokens are often used for authentication by associating a <code>user_id</code> to a string.</p><nav class="toc"><ul><li><a href="#backends">Backends</a><ul><li><a href="#json-web-token">JSON Web Token</a></li><li><a href="#server-side">Server-side</a></li><li><a href="#installation">Installation</a><ul><li><a href="#backend">Backend</a></li><li><a href="#registration">Registration</a></li><li><a href="#migrations">Migrations</a></li></ul></li><li><a href="#usage">Usage</a><ul><li><a href="#middleware">Middleware</a></li></ul></li></ul></li></ul></nav></header><h2 id="backends"><a href="#backends" class="anchor"></a>Backends</h2><p><code>sihl-token</code> ships with 4 backend implementations.</p><h3 id="json-web-token"><a href="#json-web-token" class="anchor"></a>JSON Web Token</h3><p><a href="jwt.io">JSON Web Token</a> (JWT) is a standard for client-side tokens. The associated data is stored in the actual token, which is signed and sent to the client.</p><p>JWTs are valid until they expire. If you want to invalidate them before, it is necessary to keep a blacklist on the server. This requires some persistent storage.</p><p>Use either <a href="Sihl_token/JwtPostgreSql/index.html"><code>Sihl_token.JwtPostgreSql</code></a> or <a href="Sihl_token/JwtMariaDb/index.html"><code>Sihl_token.JwtMariaDb</code></a>.</p><h3 id="server-side"><a href="#server-side" class="anchor"></a>Server-side</h3><p>Server-side tokens have their data persisted on the server. This is useful for sensitive information.</p><p>Use either <a href="Sihl_token/PostgreSql/index.html"><code>Sihl_token.PostgreSql</code></a> or <a href="Sihl_token/MariaDb/index.html"><code>Sihl_token.MariaDb</code></a>.</p><h3 id="installation"><a href="#installation" class="anchor"></a>Installation</h3><h4 id="backend"><a href="#backend" class="anchor"></a>Backend</h4><p>First, choose a backend in <code>service/service.ml</code>:</p><pre><code class="ml">module Token = Sihl_token.JwtPostgresql</code></pre><h4 id="registration"><a href="#registration" class="anchor"></a>Registration</h4><p>Register the service in <code>run/run.ml</code>:</p><pre><code class="ml">let services = [ Service.Token.register () ]</code></pre><h4 id="migrations"><a href="#migrations" class="anchor"></a>Migrations</h4><p>Run <code>make sihl migrate</code> to run pending migrations.</p><h3 id="usage"><a href="#usage" class="anchor"></a>Usage</h3><p>The API is documented in <a href="../sihl/Sihl__/Contract_token/module-type-Sig/index.html"><code>Sihl.Contract.Token.Sig</code></a>.</p><h4 id="middleware"><a href="#middleware" class="anchor"></a>Middleware</h4><p>The token middleware <span class="xref-unresolved" title="unresolved reference to &quot;Sihl.Contract.Token.Sig.Web.Middleware.user&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Sihl.Contract.Token.Sig.Web.Middleware&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Sihl.Contract.Token.Sig.Web&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Sihl.Contract.Token.Sig&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Sihl.Contract.Token&quot;"><span class="xref-unresolved" title="unresolved reference to &quot;Sihl.Contract&quot;"><code>Sihl</code>.Contract</span>.Token</span>.Sig</span>.Web</span>.Middleware</span>.user</span> fetches the current user based on the provided <code>Bearer Token</code>.</p><pre><code class="ml">let index req =

  match Service.Token.Web.User.find_opt req with
  | None -&gt; Lwt.return @@ Sihl.Web.Response.redirect_to &quot;/login&quot;
  | Some user -&gt; Lwt.return @@ Sihl.Web.Response.of_html (View.Welcome.index user)
;;</code></pre></div></body></html>