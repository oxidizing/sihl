<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Middleware (sihl.Sihl.Web.Middleware)</title><link rel="stylesheet" href="../../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../../../index.html">sihl</a> &#x00BB; <a href="../../index.html">Sihl</a> &#x00BB; <a href="../index.html">Web</a> &#x00BB; Middleware</nav><h1>Module <code>Web.Middleware</code></h1></header><dl><dt class="spec value" id="val-csrf"><a href="#val-csrf" class="anchor"></a><code><span class="keyword">val</span> csrf : <span>?&#8288;not_allowed_handler:<span>(Rock.Request.t <span>&#45;&gt;</span> <span>Rock.Response.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;cookie_key:string</span> <span>&#45;&gt;</span> <span>?&#8288;input_name:string</span> <span>&#45;&gt;</span> <span>?&#8288;secret:string</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>csrf ?not_allowed_handler ?cookie_key ?input_name ?secret ()</code> returns a middleware that enables CSRF protection for unsafe HTTP requests.</p><p><code>not_allowed_handler</code> is used if an unsafe request does not pass the CSRF protection check. By default, <code>not_allowed_handler</code> returns an empty response with status 403.</p><p><code>cookie_key</code> is the key in the cookie under which a CSRF token will be stored. By default, <code>cookie_key</code> has a <code>__Host</code> prefix to increase cookie security. One important consequence of this prefix is, that the cookie cannot be sent across unencrypted (HTTP) connections. You should only set this argument if you know what you are doing and aware of the consequences.</p><p><code>input_name</code> is the name of the input element that is used to send the CSRF token. By default, the value is <code>_csrf</code>. It is recommended to use a <code>&lt;hidden&gt;</code> field in a <code>&lt;form&gt;</code>.</p><p><code>secret</code> is the secret used to hash the CSRF cookie value with. By default, <code>SIHL_SECRET</code> is used.</p><p>Internally, the CSRF protection is implemented as the Double Submit Cookie approach.</p></dd></dl><dl><dt class="spec value" id="val-error"><a href="#val-error" class="anchor"></a><code><span class="keyword">val</span> error : <span>?&#8288;email_config:<span>(string * string * <span>(<a href="../../../Sihl__/Contract_email/index.html#type-t">Sihl__.Contract_email.t</a> <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;reporter:<span>(Opium.Request.t <span>&#45;&gt;</span> string <span>&#45;&gt;</span> <span>unit Lwt.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;error_handler:<span>(Rock.Request.t <span>&#45;&gt;</span> <span>Rock.Response.t Lwt.t</span>)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>error ?email_config ?reporter ?handler ()</code> returns a middleware that catches all exceptions and shows them.</p><p>By default, it logs the exception with the request details. The response is either `text/html` or `application/json`, depending on the `Content-Type` header of the request. If SIHL_ENV is `development`, a more detailed debugging page is shown which makes development easier. You can override the error page/JSON that is shown by providing a custom error handler <code>error_handler</code>.</p><p>Optional email configuration <code>email_config</code> can be specified, which is a tuple (sender, recipient, send_function). Exceptions that are caught will be sent per email to <code>recipient</code> where <code>sender</code> is the sender of the email. Pass in the send function of the Sihl email service or provide your own <code>send_function</code>.</p><p>An optional custom reporter <code>reporter</code> can be defined. The middleware passes the request and the stringified exception to the reporter callback. Use the reporter to implement custom error reporting.</p></dd></dl><dl><dt class="spec value" id="val-flash"><a href="#val-flash" class="anchor"></a><code><span class="keyword">val</span> flash : <span>?&#8288;cookie_key:string</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>flash ?cookie_key ()</code> returns a middleware that is used to read and store flash data. Flash data is session data that is valid between two requests. A typical use case is displaying error messages after submitting forms.</p><p><code>cookie_key</code> is the cookie name. By default, the value is <code>_flash</code>.</p><p>The flash data is stored in a separate flash cookie. The usual limitations apply such as a maximum of 4KB. Note that the cookie is not signed, don't put any data into the flash cookie that you have to trust.</p></dd></dl><dl><dt class="spec value" id="val-id"><a href="#val-id" class="anchor"></a><code><span class="keyword">val</span> id : unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>id ()</code> returns a middleware that reads the <code>X-Request-ID</code> headers and assigns it to the request.</p><p>If no <code>X-Request-ID</code> is present, a random id is generated which is assigned to the request. The random id is a 64 byte long base64 encoded string. There is no uniqueness guarantee among ids of pending requests. However, generating two identical ids in a short period of time is highly unlikely.</p></dd></dl><dl><dt class="spec value" id="val-migration"><a href="#val-migration" class="anchor"></a><code><span class="keyword">val</span> migration : <span>(unit <span>&#45;&gt;</span> <span><span><span>(string * int)</span> list</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>migration fetch_pending_migrations</code> returns a middleware that shows a warning page in case there are pending migrations. The middleware shows a generic internal error page if <code>SIHL_ENV</code> is <code>production</code> to not leak information.</p><p><code>fetch_pending_migrations</code> is a function that returns a list of pending migrations. Use the <code>pending_migration</code> function of the migration service. If the returned list is empty, there are no pending migrations.</p></dd></dl><dl><dt class="spec value" id="val-trailing_slash"><a href="#val-trailing_slash" class="anchor"></a><code><span class="keyword">val</span> trailing_slash : unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>trailing_slash ()</code> returns a middleware that removes all trailing slashes <code>/</code> from the request URI path. Apply it globally (before the router) to make sure that a path <code>/foo/bar/</code> matches the route <code>/foo/bar</code>.</p><p>Multiple trailing slashes are removed.</p></dd></dl><dl><dt class="spec value" id="val-static_file"><a href="#val-static_file" class="anchor"></a><code><span class="keyword">val</span> static_file : unit <span>&#45;&gt;</span> Rock.Middleware.t</code></dt><dd><p><code>static_file ()</code> returns a middleware that serves static files.</p><p>The directory that is served can be configured with <code>PUBLIC_DIR</code>. By default, the value is <code>./public</code>.</p><p>The path under which the file are accessible can be configured with <code>PUBLIC_URI_PREFIX</code>. By default, the value is <code>/assets</code>.</p></dd></dl></div></body></html>