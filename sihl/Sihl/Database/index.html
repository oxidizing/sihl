<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Database (sihl.Sihl.Database)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">sihl</a> &#x00BB; <a href="../index.html">Sihl</a> &#x00BB; Database</nav><h1>Module <code>Sihl.Database</code></h1></header><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../../Sihl__/Contract_database/index.html#module-type-Sig">Sihl__.Contract_database.Sig</a></code></span></summary><dl><dt class="spec type" id="type-prepared_search_request"><a href="#type-prepared_search_request" class="anchor"></a><code><span class="keyword">type</span> <span>'a prepared_search_request</span></code></dt><dd><p><code>'a prepared_search_request</code> is a prepared SQL statement that can be used to sort, filter and paginate (= search) a collection.</p></dd></dl><dl><dt class="spec value" id="val-prepare_requests"><a href="#val-prepare_requests" class="anchor"></a><code><span class="keyword">val</span> prepare_requests : string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string <span>&#45;&gt;</span> string</code></dt><dt class="spec value" id="val-prepare_search_request"><a href="#val-prepare_search_request" class="anchor"></a><code><span class="keyword">val</span> prepare_search_request : <span>search_query:string</span> <span>&#45;&gt;</span> <span>filter_fragment:string</span> <span>&#45;&gt;</span> <span>?&#8288;sort_by_field:string</span> <span>&#45;&gt;</span> <span>?&#8288;format_filter:<span>(string <span>&#45;&gt;</span> string)</span></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Caqti_type.t</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-prepared_search_request">prepared_search_request</a></span></code></dt><dd><p><code>prepare_search_request ~search_query ~count_query ~filter_fragment
      ?sort_by_field type</code> returns a prepared SQL statement <code>'a prepared_search_request</code> by assembling the SQL query from the provided fragments.</p><p><code>search_query</code> is the <code>SELECT ... FROM table</code> part of the query.</p><p><code>count_query</code> is a query that is executed by Sihl after the search in order to obtain the total number of items in the table. For example <code>SELECT COUNT(\*\) FROM table</code>.</p><p><code>filter_fragment</code> is the fragment that is appended to <code>search_query</code> for filtering. Usually you want ot <code>OR</code> fields that are often searched for. For example <code>WHERE table.field1 LIKE $1 OR table.field2 $1 OR table.field3 LIKE $1</code>.</p><p><code>sort_by_field</code> is an optional field name that is used for sorting. By default, the field &quot;id&quot; is used. Note that in order to prepare the requests, the sort field has to be known beforehand. If you want to dynamically set the field, you need to write your own query at runtime.</p><p><code>format_filter</code> is a function applied to the filter keyword before it is passed to the database. By default, a keyword &quot;keyword&quot; is formatted to &quot;%skeyword%s&quot;. This might not be what you want performance-wise. If you need full control, pass in the identity function and format the keyword yourself.</p><p><code>type</code> is the caqti type of an item of the collection.</p></dd></dl><dl><dt class="spec value" id="val-run_request"><a href="#val-run_request" class="anchor"></a><code><span class="keyword">val</span> run_request : <span>(<span class="keyword">module</span> Caqti_lwt.CONNECTION)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="index.html#type-prepared_search_request">prepared_search_request</a></span> <span>&#45;&gt;</span> <span>[&lt; `Asc <span>| `Desc</span> ]</span> <span>&#45;&gt;</span> <span><span class="type-var">'c</span> option</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span>(<span><span class="type-var">'b</span> list</span> * int)</span> Lwt.t</span></code></dt><dt class="spec value" id="val-run_search_request"><a href="#val-run_search_request" class="anchor"></a><code><span class="keyword">val</span> run_search_request : <span><span class="type-var">'a</span> <a href="index.html#type-prepared_search_request">prepared_search_request</a></span> <span>&#45;&gt;</span> <span>[ `Asc <span>| `Desc</span> ]</span> <span>&#45;&gt;</span> <span>string option</span> <span>&#45;&gt;</span> <span>limit:int</span> <span>&#45;&gt;</span> <span>offset:int</span> <span>&#45;&gt;</span> <span><span>(<span><span class="type-var">'a</span> list</span> * int)</span> Lwt.t</span></code></dt><dd><p><code>run_search_request prepared_request sort filter ~limit ~offset</code> runs the <code>prepared_request</code> and returns a partial result of the whole stored collection. The second element of the result tuple is the total amount of items in the whole collection.</p><p><code>prepared_request</code> is the returned prepared request by <a href="index.html#val-prepare_search_request"><code>prepare_search_request</code></a>.</p><p><code>sort</code> is the sort order. The field that is sorted by was set by <a href="index.html#val-prepare_search_request"><code>prepare_search_request</code></a>.</p><p><code>filter</code> is an optional keyword that is used to filter the collection. If no filter is provided, the collection is not filtered.</p><p><code>offset</code> is the number of items that the returned partial result is offset by.</p><p><code>limit</code> is the number of items of the returned partial result.</p><p><code>offset</code> and <code>limit</code> can be used together to implement pagination.</p></dd></dl><dl><dt class="spec value" id="val-raise_error"><a href="#val-raise_error" class="anchor"></a><code><span class="keyword">val</span> raise_error : <span><span>(<span class="type-var">'a</span>, Caqti_error.t)</span> Result.t</span> <span>&#45;&gt;</span> <span class="type-var">'a</span></code></dt><dd><p><code>raise_error err</code> raises a printable caqti error <code>err</code> .</p></dd></dl><dl><dt class="spec value" id="val-fetch_pool"><a href="#val-fetch_pool" class="anchor"></a><code><span class="keyword">val</span> fetch_pool : unit <span>&#45;&gt;</span> <span><span>(Caqti_lwt.connection, Caqti_error.t)</span> Caqti_lwt.Pool.t</span></code></dt><dd><p><code>fetch_pool ()</code> returns the connection pool that was set up. If there was no connection pool set up, setting it up now.</p></dd></dl><dl><dt class="spec value" id="val-find_opt"><a href="#val-find_opt" class="anchor"></a><code><span class="keyword">val</span> find_opt : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[&lt; `One <span>| `Zero</span> ]</span>)</span> Caqti_request.t</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span><span class="type-var">'b</span> option</span> Lwt.t</span></code></dt><dd><p><code>find_opt request input</code> runs a caqti <code>request</code> in the connection pool where <code>input</code> is the input of the caqti request and returns one row or <code>None</code>. Returns <code>None</code> if no rows are found.</p><p>Note that the caqti request is only allowed to return one or zero rows, not many.</p></dd></dl><dl><dt class="spec value" id="val-find"><a href="#val-find" class="anchor"></a><code><span class="keyword">val</span> find : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[&lt; `One ]</span>)</span> Caqti_request.t</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span class="type-var">'b</span> Lwt.t</span></code></dt><dd><p><code>find request input</code> runs a caqti <code>request</code> on the connection pool where <code>input</code> is the input of the caqti request and returns one row. Raises an exception if no row was found.</p><p>Note that the caqti request is only allowed to return one or zero rows, not many.</p></dd></dl><dl><dt class="spec value" id="val-collect"><a href="#val-collect" class="anchor"></a><code><span class="keyword">val</span> collect : <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[&lt; `One <span>| `Zero</span> <span>| `Many</span> ]</span>)</span> Caqti_request.t</span> <span>&#45;&gt;</span> <span class="type-var">'a</span> <span>&#45;&gt;</span> <span><span><span class="type-var">'b</span> list</span> Lwt.t</span></code></dt><dd><p><code>collect request input</code> runs a caqti <code>request</code> on the connection pool where <code>input</code> is the input of the caqti request and retuns a list of rows.</p><p>Note that the caqti request is allowed to return one, zero or many rows.</p></dd></dl><dl><dt class="spec value" id="val-exec"><a href="#val-exec" class="anchor"></a><code><span class="keyword">val</span> exec : <span><span>(<span class="type-var">'b</span>, unit, <span>[&lt; `Zero ]</span>)</span> Caqti_request.t</span> <span>&#45;&gt;</span> <span class="type-var">'b</span> <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dd><p><code>exec request input</code> runs a caqti <code>request</code> on the connection pool.</p><p>Note that the caqti request is not allowed to return any rows.</p><p>Use <a href="index.html#val-exec"><code>exec</code></a> to run mutations.</p></dd></dl><dl><dt class="spec value" id="val-query"><a href="#val-query" class="anchor"></a><code><span class="keyword">val</span> query : <span>(Caqti_lwt.connection <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dd><p><code>query f</code> runs the query <code>f</code> on the connection pool and returns the result. If the query fails the Lwt.t fails as well.</p></dd></dl><dl><dt class="spec value" id="val-query'"><a href="#val-query'" class="anchor"></a><code><span class="keyword">val</span> query' : <span>(Caqti_lwt.connection <span>&#45;&gt;</span> <span><span><span>(<span class="type-var">'a</span>, Caqti_error.t)</span> Result.t</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dd><p><code>query' f</code> runs the query <code>f</code> on the connection pool and returns the result. Use <code>query'</code> instead of <a href="index.html#val-query"><code>query</code></a> as a shorthand when you have a single caqti request to execute.</p></dd></dl><dl><dt class="spec value" id="val-transaction"><a href="#val-transaction" class="anchor"></a><code><span class="keyword">val</span> transaction : <span>(Caqti_lwt.connection <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dd><p><code>transaction f</code> runs the query <code>f</code> on the connection pool in a transaction and returns the result. If the query fails the Lwt.t fails as well and the transaction gets rolled back. If the database driver doesn't support transactions, <code>transaction</code> gracefully becomes <a href="index.html#val-query"><code>query</code></a>.</p></dd></dl><dl><dt class="spec value" id="val-transaction'"><a href="#val-transaction'" class="anchor"></a><code><span class="keyword">val</span> transaction' : <span>(Caqti_lwt.connection <span>&#45;&gt;</span> <span><span><span>(<span class="type-var">'a</span>, Caqti_error.t)</span> Result.t</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Lwt.t</span></code></dt><dd><p><code>transaction' f</code> runs the query <code>f</code> on the connection pool in a transaction and returns the result. If the query fails the Lwt.t fails as well and the transaction gets rolled back. If the database driver doesn't support transactions, <code>transaction'</code> gracefully becomes <a href="index.html#val-query'"><code>query'</code></a>.</p></dd></dl><dl><dt class="spec value" id="val-register"><a href="#val-register" class="anchor"></a><code><span class="keyword">val</span> register : unit <span>&#45;&gt;</span> <a href="../../Sihl__/Core_service/index.html#type-t">Sihl__.Core_container.Service.t</a></code></dt></dl><div><div class="spec include"><div class="doc"><details open="open"><summary><span class="def"><code><span class="keyword">include</span> <a href="../../Sihl__/Core_service/index.html#module-type-Sig">Sihl__.Core_container.Service.Sig</a></code></span></summary><dl><dt class="spec value" id="val-lifecycle"><a href="#val-lifecycle" class="anchor"></a><code><span class="keyword">val</span> lifecycle : <a href="../../Sihl__/Core_lifecycle/index.html#type-lifecycle">Sihl__.Core_lifecycle.lifecycle</a></code></dt></dl></details></div></div></div></details></div></div></div><dl><dt class="spec type" id="type-database"><a href="#type-database" class="anchor"></a><code><span class="keyword">type</span> database</code><code> = </code><table class="variant"><tr id="type-database.MariaDb" class="anchored"><td class="def constructor"><a href="#type-database.MariaDb" class="anchor"></a><code>| </code><code><span class="constructor">MariaDb</span></code></td></tr><tr id="type-database.PostgreSql" class="anchored"><td class="def constructor"><a href="#type-database.PostgreSql" class="anchor"></a><code>| </code><code><span class="constructor">PostgreSql</span></code></td></tr></table></dt></dl><dl><dt class="spec value" id="val-used_database"><a href="#val-used_database" class="anchor"></a><code><span class="keyword">val</span> used_database : unit <span>&#45;&gt;</span> <span><a href="index.html#type-database">database</a> option</span></code></dt><dd><p><code>used_database ()</code> returns the database that is defined in <code>DATABASE_URL</code>, <code>None</code> if an unsupported database is used.</p></dd></dl><dl><dt class="spec value" id="val-start"><a href="#val-start" class="anchor"></a><code><span class="keyword">val</span> start : unit <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dt class="spec value" id="val-stop"><a href="#val-stop" class="anchor"></a><code><span class="keyword">val</span> stop : unit <span>&#45;&gt;</span> <span>unit Lwt.t</span></code></dt><dt class="spec value" id="val-lifecycle"><a href="#val-lifecycle" class="anchor"></a><code><span class="keyword">val</span> lifecycle : <a href="../Container/index.html#type-lifecycle">Container.lifecycle</a></code></dt><dt class="spec value" id="val-register"><a href="#val-register" class="anchor"></a><code><span class="keyword">val</span> register : unit <span>&#45;&gt;</span> <a href="../Container/Service/index.html#type-t">Container.Service.t</a></code></dt></dl><div class="spec module" id="module-Migration"><a href="#module-Migration" class="anchor"></a><code><span class="keyword">module</span> Migration = <a href="../../Sihl__/index.html#module-Database_migration">Sihl__.Database_migration</a></code></div></div></body></html>