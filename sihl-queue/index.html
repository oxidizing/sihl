<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>index (sihl-queue.index)</title><link rel="stylesheet" href="../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ sihl-queue</nav><h1 id="sihl-queue"><a href="#sihl-queue" class="anchor"></a>Sihl Queue</h1><p>Queues are useful for running jobs in the background. Typical use cases are exporting tables as CSV files or sending emails over SMTP that take too long to perform during an HTTP request.</p><p>In essence, you create a <code>job</code> and register it with a job worker. In your app, use <a href="../sihl/Sihl/Contract/Queue/module-type-Sig/index.html#val-dispatch"><code>Sihl.Contract.Queue.Sig.dispatch</code></a> to put the <code>job</code> onto a queue for later processing.</p><nav class="toc"><ul><li><a href="#backends">Backends</a></li><li><a href="#installation">Installation</a><ul><li><a href="#backend">Backend</a></li><li><a href="#registration">Registration</a></li><li><a href="#migrations">Migrations</a></li><li><a href="#usage">Usage</a><ul><li><a href="#creating-jobs">Creating jobs</a></li><li><a href="#dispatching-jobs">Dispatching jobs</a></li><li><a href="#dashboard">Dashboard</a><ul><li><a href="#htmx">HTMX</a></li></ul></li></ul></li></ul></li></ul></nav></header><h2 id="backends"><a href="#backends" class="anchor"></a>Backends</h2><p><code>sihl-queue</code> ships with 3 backend implementations.</p><ul><li><a href="Sihl_queue/InMemory/index.html"><code>Sihl_queue.InMemory</code></a></li><li><a href="Sihl_queue/PostgreSql/index.html"><code>Sihl_queue.PostgreSql</code></a></li><li><a href="Sihl_queue/MariaDb/index.html"><code>Sihl_queue.MariaDb</code></a></li></ul><h2 id="installation"><a href="#installation" class="anchor"></a>Installation</h2><h3 id="backend"><a href="#backend" class="anchor"></a>Backend</h3><p>First, choose a backend in <code>service/service.ml</code>:</p><pre><code class="ml">module Queue = Sihl_queue.PostgreSql</code></pre><h3 id="registration"><a href="#registration" class="anchor"></a>Registration</h3><p>Register the service in <code>run/run.ml</code>:</p><pre><code class="ml">let services = [ Service.Queue.register ~jobs:[] () ]</code></pre><h3 id="migrations"><a href="#migrations" class="anchor"></a>Migrations</h3><p>Run <code>make sihl migrate</code> to run pending migrations.</p><h3 id="usage"><a href="#usage" class="anchor"></a>Usage</h3><p>The service API is documented in <a href="../sihl/Sihl__/Contract_queue/module-type-Sig/index.html"><code>Sihl.Contract.Queue.Sig</code></a>.</p><h4 id="creating-jobs"><a href="#creating-jobs" class="anchor"></a>Creating jobs</h4><p>With <span class="xref-unresolved" title="unresolved reference to &quot;Sihl_queue.create&quot;"><a href="Sihl_queue/index.html"><code>Sihl_queue</code></a>.create</span> you can create a job in <code>app/job/job.ml</code>:</p><pre><code class="ml">let cook_pizza =
  Sihl_queue.create
    (fun pizza_name -&gt;
      Pizza.create_pizza pizza_name [] |&gt; Lwt.map ignore |&gt; Lwt.map Result.ok)
    &quot;cook-pizza&quot;
;;</code></pre><p>Don't forget to register the job with the queue service. The queue service comes with queue workers which need to know about the jobs available. In <code>run.ml</code>:</p><pre><code class="ml">let services =
  [ Sihl.Database.register ()
  ; Service.Migration.(register ~migrations:Database.Migration.all ())
  ; Service.Queue.register ~jobs:[ Job.cook_pizza; Job.order_ingredient ] ()
  ]
;;</code></pre><h4 id="dispatching-jobs"><a href="#dispatching-jobs" class="anchor"></a>Dispatching jobs</h4><p>You can only dispatch jobs that have been registered.</p><pre><code class="ml">Service.Queue.dispatch ~input:&quot;funghi&quot; cook_pizza</code></pre><pre><code class="ml">Service.Queue.dispatch
  ~input:&quot;funghi&quot;
  ~delay:(Sihl.Time.Span.minutes 2)
  Job.cook_pizza</code></pre><p>The returned <code>Lwt.t</code> resolves as soon as the job is queued.</p><p>You can also dispatch multiple jobs of the same type with different inputs. Following dispatches the same job 3 times with different inputs.</p><pre><code class="ml">Service.Queue.dispatch_all
  ~input:[&quot;funghi&quot;; &quot;salami&quot;; &quot;prosciutto&quot;]
  ~delay:(Sihl.Time.Span.hours 1)
  Job.cook_pizza</code></pre><h4 id="dashboard"><a href="#dashboard" class="anchor"></a>Dashboard</h4><p><code>sihl-queue</code> comes with a built-in dashboard. The dashboard is packaged as a router <a href="../sihl/Sihl/Contract/Queue/module-type-Sig/index.html#val-router"><code>Sihl.Contract.Queue.Sig.router</code></a> and can be mounted into any existing app.</p><p>In order to only allow authenticated users to use the dashboard you can add your custom authentication and authorization middlewares. In <code>routes/site.ml</code>:</p><pre><code class="ml">let router_admin_queue =
  Service.Queue.router
    ~back:&quot;/&quot;
    ~prefix:&quot;/path&quot;
    &quot;/admin/queue&quot;</code></pre><p>In <code>run.ml</code>:</p><pre><code class="ml">let services =
  [ Sihl.Database.register ()
  ; Service.Migration.(register ~migrations:Database.Migration.all ())
  ; Sihl.Web.Http.register
      ~middlewares:Routes.Global.middlewares
      ~routers:
        [ Routes.Api.router
        ; Routes.Site.router_admin_queue
        ]
      ()
  ; Service.Queue.register ~jobs:[ Job.cook_pizza; Job.order_ingredient ] ()
  ]
;;</code></pre><h5 id="htmx"><a href="#htmx" class="anchor"></a>HTMX</h5><p>The dashboard has built-in support for <a href="https://htmx.org/">HTMX</a>. However, it is not requird to use HTMX and the dahsboard remains usable without. HTMX is used for dynamic features like auto-refreshing parts of the job instance list.</p><p>In order to use HTMX set <code>HTMX_SCRIPT_URL</code> to the URL of the HTMX JavaScript file, either served by Sihl from <code>public</code> or by a CDN.</p></div></body></html>